try {
  const all = $input.all ? $input.all() : [];
  const entry = all.length ? (all[0].json || all[0]) : {};
  const triggerData = $node["Google Drive Trigger"]?.json || {};

  let groqResponse =
    entry.text ||
    entry.content ||
    entry.message?.content ||
    entry.choices?.[0]?.message?.content ||
    '';

  // Clean code block safely
  let cleanedResponse = String(groqResponse)
    .replace(/```json/gi, '')
    .replace(/```/g, '')
    .trim();

  let data;
  try {
    data = JSON.parse(cleanedResponse);
  } catch {
    const match = cleanedResponse.match(/\{[\s\S]*\}/);
    if (!match) throw new Error('No JSON found');
    data = JSON.parse(match[0]);
  }

  // EMAIL HANDLING
  let emailOut = 'Not provided';
  if (data.email && typeof data.email === 'string') {
    const email = data.email.trim();

    const isValid =
      email.includes('@') &&
      email.includes('.') &&
      !email.includes('@github.com') &&
      !email.includes('@linkedin.com');

    if (isValid) {
      emailOut = email;
    }
  }

  // PHONE HANDLING
  let phoneOut = 'Not provided';
  if (data.phone && typeof data.phone === 'string') {
    const digits = data.phone.replace(/\D/g, '');

    if (digits.length === 10) {
      phoneOut = "'+91 " + digits;
    } else if (digits.length === 12 && digits.startsWith('91')) {
      phoneOut = "'+91 " + digits.slice(2);
    } else if (digits.length > 0) {
      phoneOut = "'+" + digits;
    }
  }

  // RED FLAGS
  let redFlags = [];

  if (Array.isArray(data.redFlags)) {
    redFlags = data.redFlags.map(r => String(r)).filter(Boolean);
  }

  if (emailOut === 'Not provided') {
    redFlags.push('Missing email address');
  }

  if (phoneOut === 'Not provided') {
    redFlags.push('Missing phone number');
  }

  // Resume quality impact
  let resumeQualityScore = Number(data.resumeQualityScore) || 50;
  if (emailOut === 'Not provided') resumeQualityScore -= 10;
  if (phoneOut === 'Not provided') resumeQualityScore -= 10;
  if (resumeQualityScore < 0) resumeQualityScore = 0;

  // Helpers
  function toText(value) {
    if (Array.isArray(value)) return value.join(', ');
    if (!value) return 'None identified';
    return String(value);
  }

  const resumeLink = triggerData.id
    ? 'https://drive.google.com/file/d/' + triggerData.id + '/view'
    : 'Not available';

  const timestamp = new Date().toLocaleString('en-IN', {
    timeZone: 'Asia/Kolkata',
    year: 'numeric',
    month: 'short',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });

  return [{
    json: {
      name: data.name || 'Not provided',
      email: emailOut,
      phone: phoneOut,
      resumeLink: resumeLink,
      score: Number(data.score) || 0,
      category: data.category || 'Not provided',
      reasoning: data.reasoning || 'Not provided',
      strengths: toText(data.strengths),
      weaknesses: toText(data.weaknesses),
      redFlags: redFlags.join(', ') || 'None identified',
      resumeQualityScore: resumeQualityScore,
      qualityNotes: data.qualityNotes || 'Standard format',
      recommendation: data.recommendation || 'Review',
      timestamp: timestamp
    }
  }];

} catch (error) {
  return [{
    json: {
      error: error.message,
      name: 'Error',
      email: 'Not provided',
      phone: 'Not provided',
      score: 0
    }
  }];
}

